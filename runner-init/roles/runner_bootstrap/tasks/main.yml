---
- name: Install base packages (Debian/Ubuntu)
  ansible.builtin.apt:
    update_cache: true
    name:
      - git
      - rsync
      - tmux
      - openssh-client
      - ca-certificates
      - curl
      - jq
      - python3
      - python3-venv
      - python3-pip
      - ansible
      - build-essential
      - libffi-dev
      - libssl-dev
    state: present
  when: ansible_facts.os_family == "Debian"

- name: Install base packages (RHEL/Fedora)
  ansible.builtin.package:
    name:
      - git
      - rsync
      - tmux
      - openssh-clients
      - ca-certificates
      - curl
      - jq
      - python3
      - python3-pip
      - ansible
      - gcc
      - gcc-c++
      - make
      - libffi-devel
      - openssl-devel
    state: present
  when: ansible_facts.os_family in ["RedHat", "Rocky", "AlmaLinux", "Fedora"]

- name: Get home directory for ansible_user
  ansible.builtin.command: "getent passwd {{ ansible_user }}"
  register: _passwd
  changed_when: false

- name: Set runner_home fact
  ansible.builtin.set_fact:
    runner_home: "{{ _passwd.stdout.split(':')[5] }}"

- name: Get primary group for ansible_user
  ansible.builtin.command: "id -gn {{ ansible_user }}"
  register: _primary_group
  changed_when: false

- name: Set runner_user_group fact
  ansible.builtin.set_fact:
    runner_user_group: "{{ _primary_group.stdout }}"

- name: Ensure ~/.ssh exists
  ansible.builtin.file:
    path: "{{ runner_home }}/.ssh"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ runner_user_group }}"
    mode: "0700"

- name: Copy SSH private key to runner (optional)
  ansible.builtin.copy:
    src: "{{ ssh_private_key_src }}"
    dest: "{{ ssh_identity_file }}"
    owner: "{{ ansible_user }}"
    group: "{{ runner_user_group }}"
    mode: "0600"
  when: (install_ssh_keys | default(false)) | bool

- name: Copy SSH public key to runner (optional)
  ansible.builtin.copy:
    src: "{{ ssh_public_key_src }}"
    dest: "{{ ssh_identity_file }}.pub"
    owner: "{{ ansible_user }}"
    group: "{{ runner_user_group }}"
    mode: "0644"
  when: (install_ssh_keys | default(false)) | bool

- name: Check SSH private key exists on runner
  ansible.builtin.stat:
    path: "{{ ssh_identity_file }}"
  register: runner_key
  become: false

- name: Fail if SSH private key is missing on runner
  ansible.builtin.fail:
    msg: >
      SSH key missing at {{ ssh_identity_file }}.
      Either copy it manually to the runner (chmod 600), or set install_ssh_keys=true and provide ssh_private_key_src.
  when: not runner_key.stat.exists

- name: Ensure correct permissions on SSH private key
  ansible.builtin.file:
    path: "{{ ssh_identity_file }}"
    owner: "{{ ansible_user }}"
    group: "{{ runner_user_group }}"
    mode: "0600"

- name: Write ~/.ssh/config (CloudLab aliases)
  ansible.builtin.template:
    src: "ssh_config.j2"
    dest: "{{ runner_home }}/.ssh/config"
    owner: "{{ ansible_user }}"
    group: "{{ runner_user_group }}"
    mode: "0600"

- name: Ensure /etc/ssh/ssh_config.d exists
  ansible.builtin.file:
    path: /etc/ssh/ssh_config.d
    state: directory
    mode: "0755"
  become: true

- name: Ensure ssh_config includes ssh_config.d snippets
  ansible.builtin.lineinfile:
    path: /etc/ssh/ssh_config
    regexp: '^Include /etc/ssh/ssh_config\.d/\*\.conf$'
    line: 'Include /etc/ssh/ssh_config.d/*.conf'
    insertafter: BOF
  become: true

- name: Install CloudLab SSH aliases system-wide
  ansible.builtin.template:
    src: "ssh_config_system_cloudlab.j2"
    dest: "/etc/ssh/ssh_config.d/99-cloudlab-aliases.conf"
    mode: "0644"
  become: true

- name: Ensure Git repo directory exists
  ansible.builtin.file:
    path: "{{ cluster_repo_dest }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ runner_user_group }}"
    mode: "0755"

- name: Clone your cluster repo
  ansible.builtin.git:
    repo: "{{ cluster_repo_url }}"
    dest: "{{ cluster_repo_dest }}"
    version: "{{ cluster_repo_version }}"
    update: true
  become: false

- name: Clone Kubespray upstream (git)
  ansible.builtin.git:
    repo: "{{ kubespray_git_url }}"
    dest: "{{ kubespray_dest }}"
    version: "{{ kubespray_version }}"
    update: true
  become: false

- name: Ensure Kubespray directory ownership
  ansible.builtin.file:
    path: "{{ kubespray_dest }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ runner_user_group }}"
    recurse: true

- name: Fail if overlay directory is missing
  ansible.builtin.stat:
    path: "{{ kubespray_overlay_dir }}/inventory/lab"
  register: overlay_stat
  become: false

- name: Stop if overlay is not present
  ansible.builtin.fail:
    msg: >
      Missing overlay at {{ kubespray_overlay_dir }}/inventory/lab.
      Put your customized inventory.ini + group_vars under kubespray-overlay/inventory/lab in your repo.
  when: not overlay_stat.stat.exists

- name: Create kubespray inventory/lab dir
  ansible.builtin.file:
    path: "{{ kubespray_dest }}/inventory/lab"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ runner_user_group }}"
    mode: "0755"

- name: Rsync overlay inventory into Kubespray
  ansible.builtin.command: >
    rsync -a --delete
    {{ kubespray_overlay_dir }}/inventory/lab/
    {{ kubespray_dest }}/inventory/lab/
  become: false

- name: Add cluster FQDNs to known_hosts (best-effort)
  ansible.builtin.shell: |
    set -e
    for h in {{ cloudlab_hosts.values() | list | join(' ') }}; do
      ssh-keyscan -H "$h" 2>/dev/null || true
    done
  args:
    executable: /bin/bash
  register: keyscan
  changed_when: false
  become: false

- name: Write scanned keys into known_hosts (best-effort)
  ansible.builtin.lineinfile:
    path: "{{ runner_home }}/.ssh/known_hosts"
    create: true
    owner: "{{ ansible_user }}"
    group: "{{ runner_user_group }}"
    mode: "0644"
    line: "{{ item }}"
    state: present
  loop: "{{ keyscan.stdout_lines | default([]) }}"
  when: (keyscan.stdout | default('')) | length > 0

- name: Done message
  ansible.builtin.debug:
    msg:
      - "Runner initialized."
      - "Repo: {{ cluster_repo_dest }}"
      - "Kubespray: {{ kubespray_dest }}"
      - "Overlay applied from: {{ kubespray_overlay_dir }}/inventory/lab -> {{ kubespray_dest }}/inventory/lab"
      - "SSH aliases installed in {{ runner_home }}/.ssh/config"
